{{template "base.html" .}}

{{define "head"}}
<style>
.chat-container {
    height: 70vh;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.chat-input-area {
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 15px;
}

.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.user {
    justify-content: flex-end;
}

.message.bot {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
}

.message.user .message-bubble {
    background: #0d6efd;
    color: white;
    border-bottom-right-radius: 4px;
}

.message.bot .message-bubble {
    background: white;
    border: 1px solid #dee2e6;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 4px;
}

.message.user .message-time {
    text-align: right;
}

.message.bot .message-time {
    text-align: left;
}

.typing-indicator {
    display: none;
    align-items: center;
    margin-bottom: 15px;
}

.typing-dots {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 18px;
    padding: 12px 16px;
}

.typing-dots span {
    height: 8px;
    width: 8px;
    background: #6c757d;
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
    margin-right: 0;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

.flow-selector {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.execution-info {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.node-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.variables-panel {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.variable-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f1f3f4;
}

.variable-item:last-child {
    border-bottom: none;
}

.variable-key {
    font-weight: 500;
    color: #495057;
}

.variable-value {
    color: #6c757d;
    font-family: monospace;
    font-size: 0.9rem;
}

.chat-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.message-input {
    flex: 1;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    padding: 10px 15px;
    outline: none;
    resize: none;
    min-height: 40px;
    max-height: 120px;
}

.send-button {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: #0d6efd;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.send-button:hover {
    background: #0b5ed7;
    transform: scale(1.05);
}

.send-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}
</style>
{{end}}

{{define "content"}}
<div class="row">
    <!-- Chat Interface -->
    <div class="col-md-8">
        <!-- Flow Selector -->
        <div class="flow-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="form-label mb-2">Select Flow to Test</label>
                    <select id="flow-select" class="form-select">
                        <option value="">Choose a flow...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2 mt-4">
                        <button id="start-test" class="btn btn-success" disabled>
                            <i class="bi bi-play-circle"></i> Start Test
                        </button>
                        <button id="reset-test" class="btn btn-outline-warning" disabled>
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button id="end-test" class="btn btn-outline-danger" disabled>
                            <i class="bi bi-stop-circle"></i> End Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Execution Info -->
        <div id="execution-info" class="execution-info" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <strong>Execution ID:</strong>
                    <div id="execution-id" class="text-muted">-</div>
                </div>
                <div class="col-md-4">
                    <strong>Current Node:</strong>
                    <div id="current-node" class="text-muted">-</div>
                </div>
                <div class="col-md-4">
                    <strong>Flow Mode:</strong>
                    <div id="flow-mode" class="text-muted">-</div>
                </div>
            </div>
        </div>
        
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="text-center text-muted py-4" id="chat-placeholder">
                    <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                    <p class="mt-2">Select a flow and start testing to begin the conversation</p>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="chat-controls">
                    <textarea id="message-input" class="message-input" placeholder="Type your message..." disabled rows="1"></textarea>
                    <button id="send-button" class="send-button" disabled>
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Current Node Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    Current Node Info
                </h6>
            </div>
            <div class="card-body">
                <div id="node-info-content">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-diagram-3 text-muted" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No active execution</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Execution Variables -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-code-square"></i>
                    Execution Variables
                </h6>
            </div>
            <div class="card-body">
                <div id="variables-content">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-braces text-muted" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No variables set</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conversation History -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    Conversation History
                </h6>
                <button id="export-history" class="btn btn-sm btn-outline-primary" disabled>
                    <i class="bi bi-download"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="history-content">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-chat-left-text text-muted" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No conversation history</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
let currentExecution = null;
let websocket = null;
let isTestActive = false;

$(document).ready(function() {
    // Load flows
    loadFlows();
    
    // Initialize WebSocket
    initWebSocket();
    
    // Check for flow_id in URL
    const urlParams = new URLSearchParams(window.location.search);
    const flowId = urlParams.get('flow_id');
    if (flowId) {
        $('#flow-select').val(flowId);
        $('#flow-select').trigger('change');
    }
    
    // Event handlers
    $('#flow-select').change(function() {
        const flowId = $(this).val();
        $('#start-test').prop('disabled', !flowId);
        
        if (!flowId) {
            resetTestInterface();
        }
    });
    
    $('#start-test').click(function() {
        startTest();
    });
    
    $('#reset-test').click(function() {
        if (confirm('Are you sure you want to reset the test? This will clear the conversation.')) {
            resetTest();
        }
    });
    
    $('#end-test').click(function() {
        if (confirm('Are you sure you want to end the test?')) {
            endTest();
        }
    });
    
    $('#send-button').click(function() {
        sendMessage();
    });
    
    $('#message-input').keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    $('#export-history').click(function() {
        exportHistory();
    });
    
    // Auto-resize textarea
    $('#message-input').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});

function loadFlows() {
    $.get('/api/flows')
        .done(function(data) {
            if (data.success && data.data) {
                const select = $('#flow-select');
                select.empty().append('<option value="">Choose a flow...</option>');
                
                data.data.forEach(function(flow) {
                    select.append(`<option value="${flow.id}">${escapeHtml(flow.name || 'Unnamed Flow')}</option>`);
                });
            }
        })
        .fail(function() {
            showToast('Error', 'Failed to load flows', 'error');
        });
}

function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;
    
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = function() {
        console.log('WebSocket connected');
    };
    
    websocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    websocket.onclose = function() {
        console.log('WebSocket disconnected');
        // Attempt to reconnect after 3 seconds
        setTimeout(initWebSocket, 3000);
    };
    
    websocket.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
}

function handleWebSocketMessage(data) {
    switch (data.type) {
        case 'execution_update':
            updateExecutionInfo(data.execution);
            break;
        case 'new_message':
            addMessage(data.message.role, data.message.content, data.message.timestamp);
            break;
        case 'node_change':
            updateCurrentNode(data.node);
            break;
    }
}

function startTest() {
    const flowId = $('#flow-select').val();
    if (!flowId) return;
    
    $.post('/api/test-chat/start', {
        flow_id: flowId,
        phone_number: 'test_user_' + Date.now()
    })
    .done(function(data) {
        if (data.success) {
            currentExecution = data.data;
            isTestActive = true;
            
            updateTestInterface();
            updateExecutionInfo(currentExecution);
            
            // Clear chat and add welcome message
            $('#chat-messages').empty();
            $('#chat-placeholder').hide();
            
            showToast('Success', 'Test started successfully', 'success');
        }
    })
    .fail(function() {
        showToast('Error', 'Failed to start test', 'error');
    });
}

function resetTest() {
    if (currentExecution) {
        endTest();
    }
    
    setTimeout(function() {
        startTest();
    }, 500);
}

function endTest() {
    if (!currentExecution) return;
    
    $.post('/api/test-chat/end', {
        execution_id: currentExecution.id
    })
    .done(function() {
        resetTestInterface();
        showToast('Success', 'Test ended successfully', 'success');
    })
    .fail(function() {
        showToast('Error', 'Failed to end test', 'error');
    });
}

function sendMessage() {
    const message = $('#message-input').val().trim();
    if (!message || !currentExecution) return;
    
    // Disable input
    $('#message-input').prop('disabled', true);
    $('#send-button').prop('disabled', true);
    
    // Add user message to chat
    addMessage('user', message);
    
    // Clear input
    $('#message-input').val('').css('height', 'auto');
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send message to server
    $.post('/api/test-chat/message', {
        execution_id: currentExecution.id,
        message: message
    })
    .done(function(data) {
        hideTypingIndicator();
        
        if (data.success) {
            // Add bot response
            addMessage('bot', data.data.response);
            
            // Update execution info
            if (data.data.execution) {
                currentExecution = data.data.execution;
                updateExecutionInfo(currentExecution);
            }
            
            // Update variables and node info
            updateVariables();
            updateNodeInfo();
        } else {
            addMessage('bot', 'Sorry, I encountered an error processing your message.');
        }
    })
    .fail(function() {
        hideTypingIndicator();
        addMessage('bot', 'Sorry, I\'m having trouble connecting right now.');
        showToast('Error', 'Failed to send message', 'error');
    })
    .always(function() {
        // Re-enable input
        $('#message-input').prop('disabled', false);
        $('#send-button').prop('disabled', false);
        $('#message-input').focus();
    });
}

function addMessage(role, content, timestamp) {
    const time = timestamp ? new Date(timestamp) : new Date();
    const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const messageHtml = `
        <div class="message ${role}">
            <div class="message-bubble">
                ${escapeHtml(content).replace(/\n/g, '<br>')}
                <div class="message-time">${timeStr}</div>
            </div>
        </div>
    `;
    
    $('#chat-messages').append(messageHtml);
    scrollToBottom();
}

function showTypingIndicator() {
    const typingHtml = `
        <div class="typing-indicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    
    $('#chat-messages').append(typingHtml);
    $('.typing-indicator').show();
    scrollToBottom();
}

function hideTypingIndicator() {
    $('.typing-indicator').remove();
}

function scrollToBottom() {
    const chatMessages = $('#chat-messages');
    chatMessages.scrollTop(chatMessages[0].scrollHeight);
}

function updateTestInterface() {
    $('#start-test').prop('disabled', true);
    $('#reset-test').prop('disabled', false);
    $('#end-test').prop('disabled', false);
    $('#message-input').prop('disabled', false);
    $('#send-button').prop('disabled', false);
    $('#export-history').prop('disabled', false);
    $('#execution-info').show();
    $('#message-input').focus();
}

function resetTestInterface() {
    currentExecution = null;
    isTestActive = false;
    
    $('#start-test').prop('disabled', $('#flow-select').val() === '');
    $('#reset-test').prop('disabled', true);
    $('#end-test').prop('disabled', true);
    $('#message-input').prop('disabled', true).val('');
    $('#send-button').prop('disabled', true);
    $('#export-history').prop('disabled', true);
    $('#execution-info').hide();
    
    // Clear chat
    $('#chat-messages').empty();
    $('#chat-placeholder').show();
    
    // Clear sidebar
    $('#node-info-content').html(`
        <div class="text-center text-muted py-3">
            <i class="bi bi-diagram-3 text-muted" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">No active execution</p>
        </div>
    `);
    
    $('#variables-content').html(`
        <div class="text-center text-muted py-3">
            <i class="bi bi-braces text-muted" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">No variables set</p>
        </div>
    `);
    
    $('#history-content').html(`
        <div class="text-center text-muted py-3">
            <i class="bi bi-chat-left-text text-muted" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">No conversation history</p>
        </div>
    `);
}

function updateExecutionInfo(execution) {
    $('#execution-id').text(execution.id || '-');
    $('#current-node').text(execution.current_node || '-');
    $('#flow-mode').html(`<span class="badge bg-${getModeColor(execution.flow_mode)}">${execution.flow_mode || 'MANUAL'}</span>`);
}

function updateVariables() {
    if (!currentExecution) return;
    
    $.get('/api/test-chat/variables/' + currentExecution.id)
        .done(function(data) {
            if (data.success && data.data) {
                const variables = data.data;
                const keys = Object.keys(variables);
                
                if (keys.length === 0) {
                    $('#variables-content').html(`
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-braces text-muted" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">No variables set</p>
                        </div>
                    `);
                } else {
                    let html = '';
                    keys.forEach(function(key) {
                        html += `
                            <div class="variable-item">
                                <span class="variable-key">${escapeHtml(key)}</span>
                                <span class="variable-value">${escapeHtml(JSON.stringify(variables[key]))}</span>
                            </div>
                        `;
                    });
                    $('#variables-content').html(html);
                }
            }
        })
        .fail(function() {
            console.error('Failed to load variables');
        });
}

function updateNodeInfo() {
    if (!currentExecution) return;
    
    $.get('/api/test-chat/node-info/' + currentExecution.id)
        .done(function(data) {
            if (data.success && data.data) {
                const node = data.data;
                
                let html = `
                    <div class="node-info">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${escapeHtml(node.label || node.id)}</strong>
                            <span class="badge bg-${getNodeTypeColor(node.type)}">${node.type}</span>
                        </div>
                `;
                
                if (node.type === 'ai_prompt') {
                    html += `
                        <div class="mb-2">
                            <small class="text-muted">System Prompt:</small><br>
                            <small>${escapeHtml(node.system_prompt || 'Not set').substring(0, 100)}${node.system_prompt && node.system_prompt.length > 100 ? '...' : ''}</small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Instance:</small> <code>${escapeHtml(node.instance || 'Not set')}</code>
                        </div>
                    `;
                } else if (node.type === 'manual') {
                    html += `
                        <div class="mb-2">
                            <small class="text-muted">Message:</small><br>
                            <small>${escapeHtml(node.message || 'Not set').substring(0, 100)}${node.message && node.message.length > 100 ? '...' : ''}</small>
                        </div>
                    `;
                }
                
                html += '</div>';
                $('#node-info-content').html(html);
            }
        })
        .fail(function() {
            console.error('Failed to load node info');
        });
}

function exportHistory() {
    if (!currentExecution) return;
    
    $.get('/api/test-chat/history/' + currentExecution.id)
        .done(function(data) {
            if (data.success && data.data) {
                const history = data.data;
                const blob = new Blob([JSON.stringify(history, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversation_${currentExecution.id}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Success', 'Conversation history exported', 'success');
            }
        })
        .fail(function() {
            showToast('Error', 'Failed to export history', 'error');
        });
}

function getModeColor(mode) {
    switch (mode) {
        case 'AUTO': return 'success';
        case 'SEMI_AUTO': return 'warning';
        case 'MANUAL': return 'secondary';
        default: return 'secondary';
    }
}

function getNodeTypeColor(type) {
    switch (type) {
        case 'ai_prompt': return 'success';
        case 'manual': return 'warning';
        case 'condition': return 'info';
        case 'delay': return 'secondary';
        default: return 'secondary';
    }
}

function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{{end}}